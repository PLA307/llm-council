# 连续对话上下文功能测试指南

## 测试目标
验证连续对话上下文功能是否生效，确保每轮对话的阶段3输出能正确传递到下一轮对话的上下文中。

## 测试环境要求
- 前端开发服务器正常运行（npm run dev）
- 后端服务器正常运行（python3 -m uv run python -m backend.main）
- 已配置有效的OpenRouter API密钥

## 测试步骤

### 1. 基本功能测试

#### 步骤1：启动应用
- 打开浏览器，访问应用地址（通常为 http://localhost:5173）
- 点击"+ 新对话"按钮创建一个新对话

#### 步骤2：发送第一轮问题
- 在输入框中输入：`什么是机器学习？`
- 点击"发送"按钮
- 等待三阶段流程完成（阶段1→阶段2→阶段3）

#### 步骤3：发送相关的第二轮问题
- 不要关闭当前对话窗口
- 在同一输入框中输入：`它有哪些常见的应用领域？`
- 点击"发送"按钮
- 等待三阶段流程完成

#### 预期结果
- 第二轮的回答应该基于第一轮对"机器学习"的解释
- 回答中应该包含类似"如前所述，机器学习是..."或"基于机器学习的特性，其常见应用包括..."的表述
- 回答应该与第一轮的上下文紧密相关

### 2. 多轮对话测试

#### 步骤1：延续上述对话，发送第三轮问题
- 输入：`这些应用中，哪个领域发展最快？`
- 发送并等待完成

#### 步骤2：发送第四轮深入问题
- 输入：`为什么这个领域发展这么快？`
- 发送并等待完成

#### 预期结果
- 每一轮的回答都应该基于之前所有轮次的上下文
- 模型应该能够记住之前提到的机器学习定义、应用领域等信息
- 回答应该保持逻辑连贯性

## 验证方法

### 1. 前端界面验证
- ✅ 输入表单持续显示，不会在对话完成后消失
- ✅ 可以在同一对话窗口中发送多条消息
- ✅ 所有消息按顺序显示在同一窗口中

### 2. 后端日志验证
- 查看后端服务器日志（terminal_id: 6）
- 寻找包含 `history_context` 的日志条目
- 确认每轮对话中都传递了上一轮的上下文信息

### 3. 模型回答验证
- 检查模型回答是否包含上一轮对话的关键信息
- 验证回答的逻辑是否基于之前的上下文
- 确认模型没有重复提问或忽略之前的回答

### 4. 网络请求验证
- 打开浏览器开发者工具（F12）
- 切换到"网络"标签
- 发送第二轮消息时，观察 `send_message` 或 `send_message_stream` 请求
- 查看请求负载，确认上下文信息是否被正确传递

### 5. 对话数据验证
- 打开浏览器开发者工具
- 切换到"应用"标签
- 查看本地存储（LocalStorage）中的对话数据
- 确认每轮对话的阶段3结果都被正确保存

## 测试用例示例

### 测试用例1：基础上下文传递
```
用户：什么是机器学习？
助手：机器学习是一种人工智能技术，允许计算机从数据中学习并在没有明确编程的情况下做出决策...

用户：它有哪些常见应用？
助手：基于机器学习的定义，其常见应用包括：
1. 图像识别与计算机视觉
2. 自然语言处理
3. 推荐系统
4. 自动驾驶
5. 医疗诊断
...
```

### 测试用例2：多轮上下文关联
```
用户：什么是Python？
助手：Python是一种高级编程语言，以其简洁的语法和强大的库支持而闻名...

用户：它适合用来做什么？
助手：Python适合多种应用场景，包括：
1. Web开发
2. 数据分析与可视化
3. 人工智能与机器学习
4. 自动化脚本
...

用户：为什么适合机器学习？
助手：Python适合机器学习主要有以下原因：
- 丰富的机器学习库（如TensorFlow、PyTorch）
- 简洁的语法便于快速开发
- 强大的数据处理能力
- 活跃的社区支持
...
```

## 故障排除

### 问题1：无法在同一窗口发送多条消息
- 检查前端ChatInterface.jsx中是否移除了输入表单的显示条件
- 确保输入表单没有被条件渲染限制

### 问题2：模型回答没有上下文关联
- 检查后端日志，确认history_context是否被正确提取
- 查看council.py中的stage1_collect_responses函数，确认上下文是否被添加到模型请求中
- 检查main.py中的上下文提取逻辑是否正确

### 问题3：对话流程中断
- 检查后端服务器是否正常运行
- 查看浏览器控制台是否有错误信息
- 验证API密钥是否有效

## 预期行为

1. **输入表单持续显示**：无论对话是否完成，输入表单始终可见
2. **上下文自动传递**：系统自动将上一轮的stage3结果作为下一轮的上下文
3. **回答连贯一致**：模型回答基于完整的对话历史
4. **无需新开窗口**：可以在同一对话窗口中完成多轮对话
5. **支持无限轮次**：理论上支持无限轮次的连续对话

## 测试完成标准

- ✅ 可以在同一对话窗口发送至少3轮相关问题
- ✅ 每轮回答都包含上一轮的上下文信息
- ✅ 模型回答保持逻辑连贯性
- ✅ 没有出现对话中断或上下文丢失
- ✅ 前端界面正常显示所有消息

## 结果记录

| 测试项 | 预期结果 | 实际结果 | 状态 | 备注 |
|--------|----------|----------|------|------|
| 输入表单持续显示 | ✅ | | | |
| 上下文传递 | ✅ | | | |
| 回答连贯性 | ✅ | | | |
| 多轮对话支持 | ✅ | | | |
| 无对话中断 | ✅ | | | |

---

测试人：__________
测试日期：__________
测试结果：□ 通过 □ 部分通过 □ 未通过